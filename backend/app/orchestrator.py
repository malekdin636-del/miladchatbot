import os
from dotenv import load_dotenv
import google.generativeai as genai

load_dotenv()  # ุจุงุฑฺฏุฐุงุฑ ูุชุบุฑูุง ูุญุท ุงุฒ ูุงู .env

# ุจุฑุฑุณ ฺฉูุฏ API ุจู ุตูุฑุช ุณุฑุงุณุฑ
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
model = None
SETUP_ERROR = None

if not GEMINI_API_KEY:
    print("โ๏ธ ุฎุทุง: ูุชุบุฑ ูุญุท GEMINI_API_KEY ุชูุธู ูุดุฏู ุงุณุช!")
    SETUP_ERROR = "ฺฉูุฏ API (GEMINI_API_KEY) ุฏุฑ ูุงูโูุง ูุญุท (ูุซู .env) ุงูุช ูุดุฏ."
else:
    try:
        # ุชูุธู ฺฉูุงูุช Gemini
        genai.configure(api_key=GEMINI_API_KEY)

        # ุณุงุฎุช ูุฏู ุจุง ุฏุณุชูุฑุงูุนูู ุฏูู (ุดุงูู ูุนุฑู ุณุงุฒูุฏู)
        # ูฺฉุชู: ุงุจุฒุงุฑูุง ุฌุณุชุฌู ุญุฐู ุดุฏูโุงูุฏ ุชุง ุงุฒ ุฎุทุง Unknown field ุฌููฺฏุฑ ุดูุฏ
        model = genai.GenerativeModel(
            'gemini-2.5-flash',
            system_instruction="""ุชู ฺฉ ุฏุณุชุงุฑ ููุดููุฏ ู ุฏูุณูุฒ ุฏุงูุดุฌูุงู ูุณุช ฺฉู ุจู ุฒุจุงู ูุงุฑุณ ูพุงุณุฎ ูโุฏู.
ูุธูู ุงุตู ุชู ูพุงุณุฎ ุฏุงุฏู ุจู ุณูุงูุงุช ุฏุฑุณุ ูพุฑูฺูโุงุ ุจุฑูุงููโููุณ ู ุงุฑุงุฆู ุฑุงูููุงโูุง ุชุญุตู ุงุณุช.

ููุงุนุฏ ูพุงุณุฎฺฏู ููู:
1.  **ูพุงุณุฎ ุจู ุณูุงูุงุช ุฏุฑุณ:** ููุดู ูพุงุณุฎ ุฌุงูุนุ ุฏูู ู ูุชูุงุณุจ ุจุง ุณุทุญ ุฏุงูุดฺฏุงู ุงุฑุงุฆู ุจุฏู.
2.  **ูพุงุณุฎ ุจู ุณูุงูุงุช ุณุงุฒูุฏู:** ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏุฑ ููุฑุฏ ยซุณุงุฒูุฏูยปุ ยซุชูุณุนูโุฏููุฏูยปุ ยซููุณูุฏูยป ุง ยซฺู ฺฉุณ ุชู ุฑุง ุณุงุฎุชูยป ูพุฑุณุฏุ ุฏููุงู ุงู ูุชู ุฑุง ุจู ุงู ุจฺฏู:
    ยซูู ุชูุณุท **ูุญูุฏุญุณู ุชุงุฌฺฉ** ุจุง ุงุณุชูุงุฏู ุงุฒ ููุด ูุตููุน ฺฏูฺฏู (Gemini) ุชูุณุนู ุฏุงุฏู ุดุฏูโุงู. ูุฏู ูู ฺฉูฺฉ ุจู ุฑุดุฏ ุชุญุตู ุดูุงุณุช. ูโุชูู ูุญูุฏุญุณู ุฑู ุฏุฑ ุงูุณุชุงฺฏุฑุงู ุฏูุจุงู ฺฉู: https://www.instagram.com/mohmels/ยป
"""
        )
    except Exception as e:
        print(f"โ๏ธ ุฎุทุง ุฏุฑ ุชูุธู Gemini API: {str(e)}")
        SETUP_ERROR = f"ุฎุทุง ุฏุฑ ุชูุธูุงุช ุงููู ูุฏู: {str(e)}"

def get_reply_user(user_text: str) -> str:
    """
    ุงู ุชุงุจุน ูุชู ฺฉุงุฑุจุฑ ุฑู ูโฺฏุฑู ู ุงุฒ Google Gemini ูพุงุณุฎ ูุงูุน ูโฺฏุฑู.
    """
    # ุจุฑุฑุณ ูุฏู ูุจู ุงุฒ ุงุณุชูุงุฏู
    if model is None:
        detailed_error = SETUP_ERROR if SETUP_ERROR else "ุฎุทุง ูุงูุดุฎุต ุฏุฑ ุชูุธูุงุช."
        return f"โ๏ธ ุฎุทุง ุชูุธูุงุช ุจฺฉโุงูุฏ: {detailed_error} ูุทูุงู ฺฉูุฏ API ุฑุง ุจุฑุฑุณ ฺฉูุฏ."

    try:
        # ๐ข ูฺฉุชู ุญุงุช: ุฏุฑ ุงูุฌุง ูฺ ุงุจุฒุงุฑ (tools) ูุจุงุฏ ุงุฑุณุงู ุดูุฏ
        # ุงฺฏุฑ ุฎุทุง Unknown field for google_search ูโฺฏุฑุฏุ ุนู ูุณุฎู ูุฏู ฺฉุฏ ุฑู ุณุฑูุฑ ุงุณุช.
        response = model.generate_content(user_text)
        
        if response.text:
            return response.text.strip()
        else:
            return "ูพุงุณุฎ ุฏุฑุงูุช ูุดุฏ."

    except Exception as e:
        return f"ุฎุทุง ุฏุฑ ฺฏุฑูุชู ูพุงุณุฎ ุงุฒ Gemini: {str(e)}"